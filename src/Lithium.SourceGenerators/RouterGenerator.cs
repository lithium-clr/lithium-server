using System.Collections.Generic;
using System.Linq;
using System.Text;
using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.CSharp.Syntax;
using Microsoft.CodeAnalysis.Text;

namespace Lithium.SourceGenerators;

[Generator]
public sealed class RouterGenerator : ISourceGenerator
{
    private const string PacketHandlerAttr = "Lithium.Server.Core.Networking.Protocol.Attributes.PacketHandlerAttribute";
    private const string BaseRouterType = "Lithium.Server.Core.Networking.Protocol.Routers.BasePacketRouter";

    public void Initialize(GeneratorInitializationContext context)
    {
        context.RegisterForSyntaxNotifications(() => new SyntaxReceiver());
    }

    public void Execute(GeneratorExecutionContext context)
    {
        if (context.SyntaxReceiver is not SyntaxReceiver receiver) return;

        var compilation = context.Compilation;
        var packetHandlerAttrSymbol = compilation.GetTypeByMetadataName(PacketHandlerAttr);
        var baseRouterSymbol = compilation.GetTypeByMetadataName(BaseRouterType);

        if (baseRouterSymbol is null) return;

        var routerClasses = new List<INamedTypeSymbol>();
        foreach (var candidateClass in receiver.CandidateClasses)
        {
            var model = compilation.GetSemanticModel(candidateClass.SyntaxTree);
            if (model.GetDeclaredSymbol(candidateClass) is not INamedTypeSymbol classSymbol || classSymbol.IsAbstract) continue;

            var currentBaseType = classSymbol.BaseType;
            while (currentBaseType is not null)
            {
                if (SymbolEqualityComparer.Default.Equals(currentBaseType, baseRouterSymbol))
                {
                    routerClasses.Add(classSymbol);
                    break;
                }
                currentBaseType = currentBaseType.BaseType;
            }
        }

        if (!routerClasses.Any()) return;

        var format = SymbolDisplayFormat.FullyQualifiedFormat;

        var sbInit = new StringBuilder();
        sbInit.AppendLine("// <auto-generated />");
        sbInit.AppendLine("using Microsoft.Extensions.DependencyInjection;");
        sbInit.AppendLine("using Lithium.Server.Core.Networking.Protocol.Routers;");
        sbInit.AppendLine("namespace Lithium.Server.Core.Networking");
        sbInit.AppendLine("{");
        sbInit.AppendLine("    public static class RouterInitializer");
        sbInit.AppendLine("    {");
        sbInit.AppendLine("        public static void InitializeRouters(System.IServiceProvider sp)");
        sbInit.AppendLine("        {");

        foreach (var router in routerClasses)
        {
            var routerVar = $"router{router.Name}";
            sbInit.AppendLine($"            var {routerVar} = sp.GetRequiredService<{router.ToDisplayString(format)}>();");

            var methods = router.GetMembers().OfType<IMethodSymbol>();
            foreach (var method in methods)
            {
                if (method.GetAttributes().Any(ad => SymbolEqualityComparer.Default.Equals(ad.AttributeClass, packetHandlerAttrSymbol)))
                {
                    if (method.Parameters.Length == 1)
                    {
                        var packetType = method.Parameters[0].Type;
                        sbInit.AppendLine($"            {routerVar}.RegisterAction<{packetType.ToDisplayString(format)}>({routerVar}.{method.Name});");
                    }
                }
            }
        }

        sbInit.AppendLine("        }");
        sbInit.AppendLine("    }");
        sbInit.AppendLine("}");
        
        context.AddSource("RouterInitializer.Generated.cs", SourceText.From(sbInit.ToString(), Encoding.UTF8));
    }

    private sealed class SyntaxReceiver : ISyntaxReceiver
    {
        public List<ClassDeclarationSyntax> CandidateClasses { get; } = [];
        public void OnVisitSyntaxNode(SyntaxNode syntaxNode) { if (syntaxNode is ClassDeclarationSyntax cds) CandidateClasses.Add(cds); }
    }
}
