using System.Collections.Generic;
using System.Linq;
using System.Text;
using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.CSharp.Syntax;
using Microsoft.CodeAnalysis.Text;

namespace Lithium.SourceGenerators;

[Generator]
public sealed class RouterGenerator : ISourceGenerator
{
    private const string PacketHandlerAttr = "Lithium.Server.Core.Networking.Protocol.Attributes.PacketHandlerAttribute";
    private const string BaseRouterType = "Lithium.Server.Core.Networking.Protocol.Routers.BasePacketRouter";

    public void Initialize(GeneratorInitializationContext context)
    {
        context.RegisterForSyntaxNotifications(() => new SyntaxReceiver());
    }

    public void Execute(GeneratorExecutionContext context)
    {
        if (context.SyntaxReceiver is not SyntaxReceiver receiver) return;

        var compilation = context.Compilation;
        var packetHandlerAttrSymbol = compilation.GetTypeByMetadataName(PacketHandlerAttr);
        var baseRouterSymbol = compilation.GetTypeByMetadataName(BaseRouterType);

        if (baseRouterSymbol is null) return;

        var routerClasses = new List<INamedTypeSymbol>();
        foreach (var candidateClass in receiver.CandidateClasses)
        {
            var model = compilation.GetSemanticModel(candidateClass.SyntaxTree);
            if (model.GetDeclaredSymbol(candidateClass) is not INamedTypeSymbol classSymbol || classSymbol.IsAbstract) continue;

            var currentBaseType = classSymbol.BaseType;
            while (currentBaseType is not null)
            {
                if (SymbolEqualityComparer.Default.Equals(currentBaseType, baseRouterSymbol))
                {
                    routerClasses.Add(classSymbol);
                    break;
                }
                currentBaseType = currentBaseType.BaseType;
            }
        }

        if (!routerClasses.Any()) return;

        var format = SymbolDisplayFormat.FullyQualifiedFormat;

        // 1. Generate RouterInitializer.cs
        var sbInit = new StringBuilder();
        sbInit.AppendLine("// <auto-generated />");
        sbInit.AppendLine("using Microsoft.Extensions.DependencyInjection;");
        sbInit.AppendLine("namespace Lithium.Server.Core.Networking");
        sbInit.AppendLine("{");
        sbInit.AppendLine("    public static class RouterInitializer");
        sbInit.AppendLine("    {");
        sbInit.AppendLine("        public static void InitializeRouters(System.IServiceProvider sp)");
        sbInit.AppendLine("        {");
        foreach (var router in routerClasses) sbInit.AppendLine($"            sp.GetRequiredService<{router.ToDisplayString(format)}>().Initialize(sp);");
        sbInit.AppendLine("        }");
        sbInit.AppendLine("    }");
        sbInit.AppendLine("}");
        context.AddSource("RouterInitializer.Generated.cs", SourceText.From(sbInit.ToString(), Encoding.UTF8));

        // 2. Generate Initialize methods for each router
        foreach (var router in routerClasses)
        {
            var sbRouter = new StringBuilder();
            sbRouter.AppendLine("// <auto-generated />");
            sbRouter.AppendLine("using Microsoft.Extensions.DependencyInjection;");
            sbRouter.AppendLine("using Lithium.Server.Core.Networking.Protocol.Routers;");
            sbRouter.AppendLine($"namespace {router.ContainingNamespace.ToDisplayString()}");
            sbRouter.AppendLine("{");
            sbRouter.AppendLine($"    public partial class {router.Name}");
            sbRouter.AppendLine("    {");
            sbRouter.AppendLine("        public override void Initialize(System.IServiceProvider sp)");
            sbRouter.AppendLine("        {");
            sbRouter.AppendLine("            base.Initialize(sp);");

            var methods = router.GetMembers().OfType<IMethodSymbol>();
            foreach (var method in methods)
            {
                if (method.GetAttributes().Any(ad => SymbolEqualityComparer.Default.Equals(ad.AttributeClass, packetHandlerAttrSymbol)))
                {
                    // Now we only care about the packet parameter, as Context is a property
                    if (method.Parameters.Length == 1)
                    {
                        var packetType = method.Parameters[0].Type;
                        sbRouter.AppendLine($"            RegisterAction<{packetType.ToDisplayString(format)}>({method.Name});");
                    }
                }
            }

            sbRouter.AppendLine("        }");
            sbRouter.AppendLine("    }");
            sbRouter.AppendLine("}");
            context.AddSource($"{router.Name}.Generated.cs", SourceText.From(sbRouter.ToString(), Encoding.UTF8));
        }
    }

    private sealed class SyntaxReceiver : ISyntaxReceiver
    {
        public List<ClassDeclarationSyntax> CandidateClasses { get; } = [];
        public void OnVisitSyntaxNode(SyntaxNode syntaxNode) { if (syntaxNode is ClassDeclarationSyntax cds) CandidateClasses.Add(cds); }
    }
}